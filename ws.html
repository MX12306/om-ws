<!DOCTYPE html>
<html lang="en">
<head>
<title>Socket Communication</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
</head>
<body>
<script type="text/javascript">

    function decodePacket( buffer /*ArrayBuffer*/ ) {

        var readString = function(dv, offset, length) {
            var utf16 = new ArrayBuffer(length * 2);
            var utf16View = new Uint16Array(utf16);
            for (var i = 0; i < length; ++i) {
                utf16View[i] = dv.getUint8(offset + i);
            }
            return String.fromCharCode.apply(null, utf16View);
        };

        var data = new DataView(buffer);

        var om = readString(data, 0, 2);

        if( om != "om" ) {
            throw new Error("Invalid packet type")
        }

        var packet = new (function OMPacket(){});

        packet.version = data.getUint8(2)
        packet.action  = data.getUint8(3)
        packet.size    = data.getUint32(4)
        packet.data    = {}

        var body = new Uint8Array(buffer.slice(8, buffer.byteLength));

        var setValue = function(key, value) {

            if( key.indexOf('.') == -1 ) {
                packet.data[key]=value;
                return;
            }

            var keys = key.split('.');

            var ref = packet.data

            for (var i = 0; i < keys.length; i++) {

                if( typeof(ref[keys[i]]) != 'undefined' &&
                    typeof(ref[keys[i]]) != 'object' ) {
                    throw new Error("Fail to set "+key+" key. Key " + keys[i] + " already present as non object");
                }
                if( typeof(ref[keys[i]]) === 'undefined' ) {
                    ref[keys[i]]={};
                }
                if( i < keys.length - 1 ) {
                    if( typeof(ref[keys[i]]) === 'object' ) {
                        ref=ref[keys[i]];
                    }
                } else {
                    ref[keys[i]] = value;
                }
            }
        }

        var key = "", chunk=[], toggle=true, separator = [0xc0,0x80];

        for (var i = 0; i < body.byteLength-1; i++) {
            if( body[i] === separator[0] &&
                body[i+1] === separator[1]) {
                chunk=String.fromCharCode.apply(null, chunk)
                if( toggle ) {
                    key = chunk;
                } else {
                    setValue(key, chunk);
                }
                chunk=[];
                toggle=!toggle;
            } else if(body[i] != separator[1]) {
                chunk.push(body[i]);
            }
        }

        return packet;
    }

    function log( data ) {
        $('body').append("<div><pre>"+JSON.stringify(data)+"</pre></div>")
    }
    if (window["WebSocket"]) {

        socket = new WebSocket("ws://{{$}}");
        socket.binaryType = 'arraybuffer';

        socket.onopen = function(event) {
            log('Connected.');
        }

        socket.onclose = function(event) {
            log("Connection closed.")
        }

        socket.onmessage = function(event) {
            if( event.data != "" ) {
                try {
                    var packet = decodePacket(event.data)
                    log(packet)
                }
                catch(e) {
                    log("Invalid packet")
                }
            }
        }
    } else {
        log("Your browser does not support WebSockets.")
    }
</script>
</body>
</html>